<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Seeding Robot Dashboard</title>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='assets/css/test.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<style>
    #map{
        width: 100%;
        height: 100%;
    }
</style>
<div id="map">
</div>
<script>
    

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/mapbox_token')
            .then(response => response.json())
            .then(data => {
                var accessToken = data.token;

                if (!accessToken) {
                    console.error('Mapbox access token not found');
                    return;
                }

                console.log('Mapbox access token:', accessToken);  // Debugging: log the token

                var map = L.map('map').setView([0, 0], 2);

                // Add OpenStreetMap layer for testing
                /*
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map); */

                // Uncomment the below code to use Mapbox Satellite layer
                
                L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=' + accessToken, {
                    attribution: '© Mapbox © OpenStreetMap',
                    maxZoom: 50,
                    tileSize: 512,
                    zoomOffset: -1
                }).addTo(map);
        
                var marker = L.marker([0, 0]).addTo(map);

                var robotPath = [];

                var socket = io.connect('http://' + document.domain + ':' + location.port + '/');

                socket.on('update_map', function(data) {
                    console.log('Data received:', data);  // Log received data
                    var lat = parseFloat(data.latitude);
                    var lon = parseFloat(data.longitude);
                    console.log('Updating marker position to:', lat, lon);  // Log new marker position
                    marker.setLatLng([lat, lon]);
                    map.setView([lat, lon], 25);

                    robotPath.push([lat, lon]);

                    L.polyline(robotPath, { color: 'red' }).addTo(map);

                    document.getElementById('longitude').innerText = 'longitude: ' + data.longitude;
                    document.getElementById('latitude').innerText = 'latitude: ' + data.latitude;
                    document.getElementById('heading').innerText = 'heading: ' + data.heading;
                    document.getElementById('roll').innerText = 'Roll: ' + data.Roll;
                    document.getElementById('pitch').innerText = 'Pitch: ' + data.Pitch;
                    document.getElementById('roll-acceleration').innerText = 'Roll Acceleration: ' + data["Roll Acceleration"];
                    document.getElementById('pitch-acceleration').innerText = 'Pitch Acceleration: ' + data["Pitch Acceleration"];
                    document.getElementById('heading-acceleration').innerText = 'Heading Acceleration: ' + data["Heading Acceleration"];
                });
            })
            .catch(error => {
                console.error('Error fetching Mapbox access token:', error);
            });
    });

</script>